<?php
/**
 * 커뮤니티 게시글 API (DB 기반 + 페이징)
 * 기존 api/community.php를 대체할 파일
 */

session_start();
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE');
header('Access-Control-Allow-Headers: Content-Type');

require_once __DIR__ . '/../config/database.php';

$pdo = getDBConnection();
if (!$pdo) {
    http_response_code(500);
    echo json_encode([
        'success' => false,
        'message' => '데이터베이스 연결 실패'
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

// GET 요청: 게시글 목록 조회 (페이징)
if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    $tab = $_GET['tab'] ?? 'free';
    $postId = $_GET['postId'] ?? null;
    $page = max(1, (int)($_GET['page'] ?? 1)); // 페이지 번호 (최소 1)
    $limit = max(1, min(100, (int)($_GET['limit'] ?? 20))); // 페이지당 개수 (1~100)
    $offset = ($page - 1) * $limit;
    
    // 특정 게시글 조회 (댓글 포함)
    if ($postId) {
        $stmt = $pdo->prepare("SELECT * FROM community_posts WHERE id = ? AND tab = ?");
        $stmt->execute([$postId, $tab]);
        $post = $stmt->fetch();
        
        if (!$post) {
            http_response_code(404);
            echo json_encode([
                'success' => false,
                'message' => '게시글을 찾을 수 없습니다.'
            ], JSON_UNESCAPED_UNICODE);
            exit;
        }
        
        // 조회수 증가 (비동기 처리 권장)
        $stmt = $pdo->prepare("UPDATE community_posts SET views = views + 1 WHERE id = ?");
        $stmt->execute([$postId]);
        
        // 댓글 가져오기
        $stmt = $pdo->prepare("
            SELECT * FROM community_comments 
            WHERE post_id = ? AND tab = ? 
            ORDER BY date ASC
        ");
        $stmt->execute([$postId, $tab]);
        $comments = $stmt->fetchAll();
        
        echo json_encode([
            'success' => true,
            'data' => $post,
            'comments' => $comments
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 게시글 목록 조회 (페이징)
    // 전체 개수 조회
    $stmt = $pdo->prepare("SELECT COUNT(*) FROM community_posts WHERE tab = ?");
    $stmt->execute([$tab]);
    $totalCount = (int)$stmt->fetchColumn();
    
    // 페이징된 게시글 조회
    $stmt = $pdo->prepare("
        SELECT * FROM community_posts 
        WHERE tab = ? 
        ORDER BY date DESC, id DESC
        LIMIT ? OFFSET ?
    ");
    $stmt->execute([$tab, $limit, $offset]);
    $posts = $stmt->fetchAll();
    
    $totalPages = ceil($totalCount / $limit);
    
    echo json_encode([
        'success' => true,
        'data' => $posts,
        'count' => count($posts),
        'pagination' => [
            'current_page' => $page,
            'per_page' => $limit,
            'total_count' => $totalCount,
            'total_pages' => $totalPages,
            'has_next' => $page < $totalPages,
            'has_prev' => $page > 1
        ],
        'tab' => $tab
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

// POST 요청: 새 게시글 작성
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $data = json_decode(file_get_contents('php://input'), true);
    
    if (!$data) {
        $data = $_POST;
    }
    
    // 유효성 검사
    if (!isset($data['title']) || empty($data['title'])) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => '제목은 필수입니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    if (!isset($data['content']) || empty($data['content'])) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => '내용은 필수입니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    $tab = $data['tab'] ?? 'free';
    $author = $_SESSION['userType'] === 'artist' ? '아티스트' : '사용자';
    $userId = $_SESSION['userId'] ?? null;
    
    // DB에 저장
    $stmt = $pdo->prepare("
        INSERT INTO community_posts 
        (user_id, author, tab, title, content, location, genre, performance_date, date, views, comments)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 0, 0)
    ");
    
    $stmt->execute([
        $userId,
        $author,
        $tab,
        $data['title'],
        $data['content'],
        $data['location'] ?? null,
        $data['genre'] ?? null,
        $data['performanceDate'] ?? null,
        date('Y-m-d')
    ]);
    
    $postId = $pdo->lastInsertId();
    
    // 저장된 게시글 조회
    $stmt = $pdo->prepare("SELECT * FROM community_posts WHERE id = ?");
    $stmt->execute([$postId]);
    $newPost = $stmt->fetch();
    
    echo json_encode([
        'success' => true,
        'message' => '게시글이 작성되었습니다.',
        'data' => $newPost
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

// PUT 요청: 게시글 수정
if ($_SERVER['REQUEST_METHOD'] === 'PUT') {
    $data = json_decode(file_get_contents('php://input'), true);
    $id = $_GET['id'] ?? $data['id'] ?? null;
    $tab = $_GET['tab'] ?? $data['tab'] ?? 'free';
    
    if (!$id) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => '게시글 ID가 필요합니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 권한 확인 (작성자만 수정 가능)
    $stmt = $pdo->prepare("SELECT user_id FROM community_posts WHERE id = ?");
    $stmt->execute([$id]);
    $post = $stmt->fetch();
    
    if (!$post) {
        http_response_code(404);
        echo json_encode([
            'success' => false,
            'message' => '게시글을 찾을 수 없습니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 작성자 확인 (간단한 예시, 실제로는 더 엄격한 권한 체크 필요)
    if ($post['user_id'] && $post['user_id'] != ($_SESSION['userId'] ?? null)) {
        http_response_code(403);
        echo json_encode([
            'success' => false,
            'message' => '수정 권한이 없습니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 업데이트할 필드 구성
    $updateFields = [];
    $updateValues = [];
    
    if (isset($data['title'])) {
        $updateFields[] = "title = ?";
        $updateValues[] = $data['title'];
    }
    if (isset($data['content'])) {
        $updateFields[] = "content = ?";
        $updateValues[] = $data['content'];
    }
    if ($tab === 'recruit') {
        if (isset($data['location'])) {
            $updateFields[] = "location = ?";
            $updateValues[] = $data['location'];
        }
        if (isset($data['genre'])) {
            $updateFields[] = "genre = ?";
            $updateValues[] = $data['genre'];
        }
    } elseif ($tab === 'collab') {
        if (isset($data['performanceDate'])) {
            $updateFields[] = "performance_date = ?";
            $updateValues[] = $data['performanceDate'];
        }
        if (isset($data['location'])) {
            $updateFields[] = "location = ?";
            $updateValues[] = $data['location'];
        }
    }
    
    if (empty($updateFields)) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => '수정할 내용이 없습니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    $updateValues[] = $id;
    $sql = "UPDATE community_posts SET " . implode(', ', $updateFields) . " WHERE id = ?";
    $stmt = $pdo->prepare($sql);
    $stmt->execute($updateValues);
    
    // 수정된 게시글 조회
    $stmt = $pdo->prepare("SELECT * FROM community_posts WHERE id = ?");
    $stmt->execute([$id]);
    $updatedPost = $stmt->fetch();
    
    echo json_encode([
        'success' => true,
        'message' => '게시글이 수정되었습니다.',
        'data' => $updatedPost
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

// DELETE 요청: 게시글 삭제
if ($_SERVER['REQUEST_METHOD'] === 'DELETE') {
    $id = $_GET['id'] ?? null;
    $tab = $_GET['tab'] ?? 'free';
    
    if (!$id) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => '게시글 ID가 필요합니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 권한 확인
    $stmt = $pdo->prepare("SELECT user_id FROM community_posts WHERE id = ?");
    $stmt->execute([$id]);
    $post = $stmt->fetch();
    
    if (!$post) {
        http_response_code(404);
        echo json_encode([
            'success' => false,
            'message' => '게시글을 찾을 수 없습니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 작성자 확인
    if ($post['user_id'] && $post['user_id'] != ($_SESSION['userId'] ?? null)) {
        http_response_code(403);
        echo json_encode([
            'success' => false,
            'message' => '삭제 권한이 없습니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 게시글 삭제 (댓글은 CASCADE로 자동 삭제)
    $stmt = $pdo->prepare("DELETE FROM community_posts WHERE id = ?");
    $stmt->execute([$id]);
    
    echo json_encode([
        'success' => true,
        'message' => '게시글이 삭제되었습니다.'
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

// 지원하지 않는 메서드
http_response_code(405);
echo json_encode([
    'success' => false,
    'message' => '지원하지 않는 HTTP 메서드입니다.'
], JSON_UNESCAPED_UNICODE);
