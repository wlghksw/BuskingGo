<?php
/**
 * 버스커 등록/조회 API (DB 기반)
 * 기존 api/buskers.php를 대체할 파일
 */

session_start();
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE');
header('Access-Control-Allow-Headers: Content-Type');

require_once __DIR__ . '/../config/database.php';

$pdo = getDBConnection();
if (!$pdo) {
    http_response_code(500);
    echo json_encode([
        'success' => false,
        'message' => '데이터베이스 연결 실패'
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

// GET 요청: 버스커 목록 조회
if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    $location = $_GET['location'] ?? '';
    $name = $_GET['name'] ?? '';
    $page = max(1, (int)($_GET['page'] ?? 1));
    $limit = max(1, min(100, (int)($_GET['limit'] ?? 20)));
    $offset = ($page - 1) * $limit;
    
    // WHERE 조건 구성
    $whereConditions = [];
    $params = [];
    
    if ($location) {
        $whereConditions[] = "preferred_location LIKE ?";
        $params[] = "%{$location}%";
    }
    
    if ($name) {
        $whereConditions[] = "name LIKE ?";
        $params[] = "%{$name}%";
    }
    
    $whereClause = !empty($whereConditions) ? "WHERE " . implode(" AND ", $whereConditions) : "";
    
    // 전체 개수 조회
    $countSql = "SELECT COUNT(*) FROM buskers {$whereClause}";
    $stmt = $pdo->prepare($countSql);
    $stmt->execute($params);
    $totalCount = (int)$stmt->fetchColumn();
    
    // 페이징된 버스커 목록 조회
    $sql = "SELECT * FROM buskers {$whereClause} ORDER BY rating DESC, performance_count DESC LIMIT ? OFFSET ?";
    $stmt = $pdo->prepare($sql);
    $params[] = $limit;
    $params[] = $offset;
    $stmt->execute($params);
    $buskers = $stmt->fetchAll();
    
    // JSON 필드 파싱
    foreach ($buskers as &$busker) {
        if ($busker['available_days']) {
            $busker['available_days'] = json_decode($busker['available_days'], true);
        }
    }
    
    $totalPages = ceil($totalCount / $limit);
    
    echo json_encode([
        'success' => true,
        'data' => $buskers,
        'count' => count($buskers),
        'pagination' => [
            'current_page' => $page,
            'per_page' => $limit,
            'total_count' => $totalCount,
            'total_pages' => $totalPages,
            'has_next' => $page < $totalPages,
            'has_prev' => $page > 1
        ]
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

// POST 요청: 새 버스커 등록
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $data = json_decode(file_get_contents('php://input'), true);
    
    // POST 데이터가 없으면 form-data로 시도
    if (!$data) {
        $data = $_POST;
    }
    
    // 유효성 검사
    if (!isset($data['name']) || empty($data['name'])) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => '팀/개인명은 필수입니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    if (!isset($data['phone']) || empty($data['phone'])) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => '연락처는 필수입니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // DB에 저장
    $availableDaysJson = null;
    if (isset($data['availableDays']) && is_array($data['availableDays'])) {
        $availableDaysJson = json_encode($data['availableDays']);
    } elseif (isset($data['availableDays']) && is_string($data['availableDays'])) {
        // 쉼표로 구분된 문자열인 경우
        $days = explode(',', $data['availableDays']);
        $availableDaysJson = json_encode($days);
    }
    
    $stmt = $pdo->prepare("
        INSERT INTO buskers 
        (user_id, name, team_size, equipment, phone, bio, available_days, preferred_time, preferred_location)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    ");
    
    try {
        $stmt->execute([
            $_SESSION['userId'] ?? null, // 로그인한 경우 user_id 연결
            $data['name'],
            isset($data['teamSize']) ? (int)$data['teamSize'] : 1,
            $data['equipment'] ?? '',
            $data['phone'],
            $data['bio'] ?? '',
            $availableDaysJson,
            $data['preferredTime'] ?? '',
            $data['preferredLocation'] ?? ''
        ]);
        
        $buskerId = $pdo->lastInsertId();
        
        // 저장된 버스커 조회
        $stmt = $pdo->prepare("SELECT * FROM buskers WHERE id = ?");
        $stmt->execute([$buskerId]);
        $newBusker = $stmt->fetch();
        
        // JSON 필드 파싱
        if ($newBusker['available_days']) {
            $newBusker['available_days'] = json_decode($newBusker['available_days'], true);
        }
        
        echo json_encode([
            'success' => true,
            'message' => '버스커가 등록되었습니다.',
            'data' => $newBusker
        ], JSON_UNESCAPED_UNICODE);
        exit;
        
    } catch (PDOException $e) {
        http_response_code(500);
        echo json_encode([
            'success' => false,
            'message' => '버스커 등록에 실패했습니다: ' . $e->getMessage()
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
}

// PUT 요청: 버스커 정보 수정
if ($_SERVER['REQUEST_METHOD'] === 'PUT') {
    $data = json_decode(file_get_contents('php://input'), true);
    $id = $_GET['id'] ?? $data['id'] ?? null;
    
    if (!$id) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => '버스커 ID가 필요합니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 권한 확인
    $stmt = $pdo->prepare("SELECT user_id FROM buskers WHERE id = ?");
    $stmt->execute([$id]);
    $busker = $stmt->fetch();
    
    if (!$busker) {
        http_response_code(404);
        echo json_encode([
            'success' => false,
            'message' => '버스커를 찾을 수 없습니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 작성자 확인
    if ($busker['user_id'] && $busker['user_id'] != ($_SESSION['userId'] ?? null)) {
        http_response_code(403);
        echo json_encode([
            'success' => false,
            'message' => '수정 권한이 없습니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 업데이트할 필드 구성
    $updateFields = [];
    $updateValues = [];
    
    if (isset($data['name'])) {
        $updateFields[] = "name = ?";
        $updateValues[] = $data['name'];
    }
    if (isset($data['teamSize'])) {
        $updateFields[] = "team_size = ?";
        $updateValues[] = (int)$data['teamSize'];
    }
    if (isset($data['equipment'])) {
        $updateFields[] = "equipment = ?";
        $updateValues[] = $data['equipment'];
    }
    if (isset($data['phone'])) {
        $updateFields[] = "phone = ?";
        $updateValues[] = $data['phone'];
    }
    if (isset($data['bio'])) {
        $updateFields[] = "bio = ?";
        $updateValues[] = $data['bio'];
    }
    if (isset($data['availableDays'])) {
        $availableDaysJson = is_array($data['availableDays']) 
            ? json_encode($data['availableDays']) 
            : json_encode(explode(',', $data['availableDays']));
        $updateFields[] = "available_days = ?";
        $updateValues[] = $availableDaysJson;
    }
    if (isset($data['preferredTime'])) {
        $updateFields[] = "preferred_time = ?";
        $updateValues[] = $data['preferredTime'];
    }
    if (isset($data['preferredLocation'])) {
        $updateFields[] = "preferred_location = ?";
        $updateValues[] = $data['preferredLocation'];
    }
    
    if (empty($updateFields)) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => '수정할 내용이 없습니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    $updateValues[] = $id;
    $sql = "UPDATE buskers SET " . implode(', ', $updateFields) . " WHERE id = ?";
    $stmt = $pdo->prepare($sql);
    $stmt->execute($updateValues);
    
    // 수정된 버스커 조회
    $stmt = $pdo->prepare("SELECT * FROM buskers WHERE id = ?");
    $stmt->execute([$id]);
    $updatedBusker = $stmt->fetch();
    
    // JSON 필드 파싱
    if ($updatedBusker['available_days']) {
        $updatedBusker['available_days'] = json_decode($updatedBusker['available_days'], true);
    }
    
    echo json_encode([
        'success' => true,
        'message' => '버스커 정보가 수정되었습니다.',
        'data' => $updatedBusker
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

// DELETE 요청: 버스커 삭제
if ($_SERVER['REQUEST_METHOD'] === 'DELETE') {
    $id = $_GET['id'] ?? null;
    
    if (!$id) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => '버스커 ID가 필요합니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 권한 확인
    $stmt = $pdo->prepare("SELECT user_id FROM buskers WHERE id = ?");
    $stmt->execute([$id]);
    $busker = $stmt->fetch();
    
    if (!$busker) {
        http_response_code(404);
        echo json_encode([
            'success' => false,
            'message' => '버스커를 찾을 수 없습니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 작성자 확인
    if ($busker['user_id'] && $busker['user_id'] != ($_SESSION['userId'] ?? null)) {
        http_response_code(403);
        echo json_encode([
            'success' => false,
            'message' => '삭제 권한이 없습니다.'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }
    
    // 버스커 삭제
    $stmt = $pdo->prepare("DELETE FROM buskers WHERE id = ?");
    $stmt->execute([$id]);
    
    echo json_encode([
        'success' => true,
        'message' => '버스커가 삭제되었습니다.'
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

// 지원하지 않는 메서드
http_response_code(405);
echo json_encode([
    'success' => false,
    'message' => '지원하지 않는 HTTP 메서드입니다.'
], JSON_UNESCAPED_UNICODE);
